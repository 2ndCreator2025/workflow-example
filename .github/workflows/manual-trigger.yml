name: Fork - Clone - Build Flutter App - Deploy to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      owner:
        description: "Repository Owner"
        required: true
      repo:
        description: "Repository"
        required: true
      fork-org:
        description: "Fork organization"
        required: true
      run-id:
        description: "Run identifier"
        required: true

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 'stable'

      - name: Print repository details
        run: |
          echo "Owner: ${{ github.event.inputs.owner }}"
          echo "Repo: ${{ github.event.inputs.repo }}"
          echo "Fork Org: ${{ github.event.inputs.fork-org }}"
          echo "Run ID: ${{ github.event.inputs.run-id }}"

      - name: Trigger GitHub Action workflow (Real-time logs)
        run: |
          curl -X POST \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com/repos/${{ github.event.inputs.owner }}/${{ github.event.inputs.repo }}/actions/workflows/manual-trigger.yml/dispatches \
          -d '{"ref":"main"}'
        
      - name: Fetch Logs in Real-Time
        run: |
          curl -X GET \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.event.inputs.owner }}/${{ github.event.inputs.repo }}/actions/runs/${{ github.event.inputs.run-id }}/logs \
          --output logs.txt
        continue-on-error: true

      - name: Display Logs
        run: |
          cat logs.txt
        continue-on-error: true

      - name: Instrument with OpenTelemetry
        run: |
          echo "Sending traces to OpenTelemetry Collector"
          curl -X POST \
          -H "Content-Type: application/json" \
          -d '{
            "traceId": "${{ github.event.inputs.run-id }}",
            "operation": "Build & Deploy Flutter App",
            "status": "success"
          }' http://otel-collector:4318/v1/traces
